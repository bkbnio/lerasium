package io.bkbn.lerasium.generated.persistence.repository

import io.bkbn.lerasium.generated.api.models.CountryModels.Create
import io.bkbn.lerasium.generated.api.models.CountryModels.Update
import io.bkbn.lerasium.generated.domain.Country
import io.bkbn.lerasium.generated.persistence.table.CountryEntity
import java.util.UUID
import kotlinx.datetime.Clock
import kotlinx.datetime.TimeZone
import kotlinx.datetime.toLocalDateTime
import org.jetbrains.exposed.sql.transactions.transaction

public object CountryRepository {
  public fun create(request: Create): Country = transaction {
    val now = Clock.System.now().toLocalDateTime(TimeZone.UTC)
    val entity = CountryEntity.new {
      this.name = request.name
      this.createdAt = now
      this.updatedAt = now
    }
    entity.to()
  }

  public fun read(id: UUID): Country = transaction {
    val entity = CountryEntity.findById(id) ?: error("""Unable to get entity with id: $id""")
    entity.to()
  }

  public fun update(id: UUID, request: Update): Country = transaction {
    val now = Clock.System.now().toLocalDateTime(TimeZone.UTC)
    val entity = CountryEntity.findById(id) ?: error("""Unable to get entity with id: $id""")
    request.name?.let { entity.name = it }
    entity.updatedAt = now
    entity.to()
  }

  public fun delete(id: UUID) = transaction {
    val entity = CountryEntity.findById(id) ?: error("""Unable to get entity with id: $id""")
    entity.delete()
  }
}
